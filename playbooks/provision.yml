---
- include: secret.yml

#- hosts: dbservers
  #become: yes
  #vars:
    #postgresql_version: 9.1
    #postgresql_encoding: 'UTF-8'
    #postgresql_databases:
      #- name: lowiki
        #owner: lowiki
    #postgresql_user_privileges:
      #- name: lowiki
        #db: lowiki
        #priv: "ALL"
        #role_attr_flags: "CREATEDB"
    #postgresql_database_extensions:
      #- db: lowiki
        #extensions:
          #- postgis
    #postgresql_ext_install_postgis: yes
  #roles:
    #- ANXS.postgresql
    #- localwiki-postgresql

- hosts: cacheservers
  become: yes
  vars:
    memcached_listen_ip: 0.0.0.0
    redis_bind_interface: 0.0.0.0
    firewall_allowed_tcp_ports:
      - "22"
    firewall_allowed_udp_ports: []
  roles:
    - geerlingguy.firewall
    - geerlingguy.memcached
    - geerlingguy.redis
  tasks:
    - name: Ensure webservers has access to cacheservers.
      lineinfile:
        dest=/etc/firewall.bash
        insertafter='^# Additional custom rules.'
        line='iptables -A INPUT -s {{ hostvars[item].ansible_eth0.ipv4.address }} -j ACCEPT'
      with_items: "{{ groups['webservers'] }}"

#- hosts: webservers
  #become: yes
  #roles:
    #- geerlingguy.apache
    #- geerlingguy.varnish
